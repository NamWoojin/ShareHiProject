pipeline {
  agent none
  options { skipDefaultCheckout(false) }
  stages {
    stage('Docker Build') {
      agent any
      steps {
        sh 'docker build -t field-pjt-back:latest ./Backend'
        sh 'docker build -t field-pjt-front:latest ./Web'
      }
    }
  
    stage('Docker Container rm') {
      agent any 
      steps {
        sh 'docker ps -f name=field-pjt-back -q | xargs --no-run-if-empty docker container stop'
        sh 'docker container ls -a -name=field-pjt-back -q | xargs -r docker container rm'

        sh 'docker ps -f name=field-pjt-front -q | xargs --no-run-if-empty docker container stop'
        sh 'docker container ls -a -name=field-pjt-front -q | xargs -r docker container rm'

        sh 'docker ps -a -f "status=exited" -q | xargs -r docker container rm'
        sh 'docker images -f "dangling=true" -q | xargs -r docker rmi'
      }
    }
    
    stage('Docker run') {
      agent any
      steps {
        sh 'docker run -d --name field-pjt-back \
            -p 8080:8080 \
            --network field-network \
            field-pjt-back:latest' 
        sh 'docker run -d --name field-pjt-front \
            -p 80:80 \
            -p 443:443 \
            -v /volumes/web_home:/volumes \
            --network field-network \
            field-pjt-front:latest'
      }
    }
  }
}
